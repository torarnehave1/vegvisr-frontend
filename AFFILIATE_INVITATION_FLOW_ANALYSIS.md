# AFFILIATE INVITATION FLOW ANALYSIS

**VEGVISR PROTOCOL - STEP 4: COMPLETE PROCESS FLOW**

## Overview

Complete end-to-end analysis of the affiliate invitation process from Superadmin initiation to email delivery, based on systematic VEGVISR protocol analysis.

---

## ðŸ”‘ TOKEN SYSTEM CLARIFICATION

**IMPORTANT**: The system uses **TWO DISTINCT TOKEN TYPES** for different purposes:

### **Token Type 1: Email Verification Token (slowyou.io)**

- **Example**: `b1ca2967e8165ec02fdf039d9e916af4005f7388`
- **Source**: Generated by slowyou.io API during user registration
- **Purpose**: Email verification for user account creation and authentication
- **Storage**: Stored in `config` table â†’ `emailVerificationToken` field
- **Lifecycle**: Created during registration â†’ Used for email verification â†’ **REMAINS** in config table
- **Scope**: User account management and authentication

### **Token Type 2: Affiliate Invitation Token (Our System)**

- **Example**: `9a533b5b-a9f6-4df7-be6b-73c0f3ab2e53` (UUID format)
- **Source**: Generated by our system using `crypto.randomUUID()`
- **Purpose**: Affiliate invitation tracking and verification
- **Storage**: Stored in `affiliate_invitations` table â†’ `token` field
- **Lifecycle**: Created during invitation â†’ Used for affiliate verification â†’ **DELETED** after successful verification
- **Scope**: Affiliate system management only

### **Key Differences:**

- **Email Verification Tokens**: Permanent, for user authentication
- **Affiliate Invitation Tokens**: Temporary, one-time use for affiliate setup

---

## ðŸ”„ COMPLETE SUPERADMIN INVITATION FLOW

### **PHASE 1: Frontend Initiation (User Interface)**

#### Step 1.1: Superadmin Dashboard Access

- **Component**: `UserDashboard.vue`
- **Action**: Superadmin logs into the system and accesses dashboard
- **Trigger**: Superadmin clicks affiliate management option
- **Method**: `openAffiliateManagement()` function called

#### Step 1.2: Affiliate Management Modal Opens

- **Component**: `AffiliateManagement.vue`
- **UI Elements**: Bootstrap modal displays affiliate invitation form
- **Form Fields**:
  - Recipient Email (required)
  - Recipient Name (required)
  - Sender Name (auto-filled: "Superadmin")
  - Site Name (default: "Vegvisr.org")
  - Commission Type (dropdown: "percentage" or "fixed")
  - Commission Rate/Amount (dynamic based on type)
  - Domain (default: "vegvisr.org")

#### Step 1.3: Form Completion and Validation

- **Component**: `AffiliateManagement.vue`
- **Validation**: Frontend validates required fields
- **Commission Logic**: Form dynamically shows rate (%) or amount ($) based on selection
- **Data Preparation**: Form data converted to JSON payload

---

### **PHASE 2: API Request (Frontend to Backend)**

#### Step 2.1: API Call Initiation

- **Method**: HTTP POST request
- **Endpoint**: `https://test.vegvisr.org/send-affiliate-invitation`
- **Headers**: `Content-Type: application/json`
- **Payload Example**:

```json
{
  "recipientEmail": "new.affiliate@example.com",
  "recipientName": "New Affiliate User",
  "senderName": "Superadmin",
  "siteName": "Vegvisr.org",
  "commissionRate": 15,
  "commissionType": "percentage",
  "domain": "vegvisr.org"
}
```

#### Step 2.2: Request Routing

- **Infrastructure**: Cloudflare Workers routing system
- **Domain**: `test.vegvisr.org` resolves to worker infrastructure
- **Worker Selection**: Request routes to `main-worker` (confirmed via testing)
- **Alternative Path**: `aff-worker` exists but not currently used for this endpoint

---

### **PHASE 3: Backend Processing (main-worker)**

#### Step 3.1: Request Reception and Validation

- **Worker**: `main-worker/index.js`
- **Endpoint Handler**: `/send-affiliate-invitation` POST handler
- **CORS**: Headers added for cross-origin requests
- **Validation**: JSON payload parsed and validated

#### Step 3.2: Database Invitation Storage (Always Execute)

- **Database**: D1 Database
- **Table**: `affiliate_invitations`
- **Logic**: **ALWAYS create invitation record regardless of existing user status**
- **Operation**: INSERT query with prepared statement
- **Token Generation**: `crypto.randomUUID()` creates unique invitation token
- **Expiry**: 7 days from creation

#### Step 3.3: Email Template Retrieval

- **Database**: D1 Database
- **Table**: `email_templates`
- **Query**: `SELECT * FROM email_templates WHERE template_type = 'affiliate_registration_invitation' AND language_code = 'en'`
- **Template Data**: Retrieved template with Handlebars HTML content and variable definitions

---

### **PHASE 4: Database Operations**

#### Step 4.1: Affiliate Invitation Storage

- **Database**: D1 Database
- **Table**: `affiliate_invitations`
- **Operation**: INSERT query with prepared statement
- **Data Stored**:
  - `token`: Generated UUID
  - `recipient_email`: From form input
  - `recipient_name`: From form input
  - `sender_name`: "Superadmin"
  - `site_name`: "Vegvisr.org"
  - `commission_type`: "percentage" or "fixed"
  - `commission_rate`: Percentage value (15.0)
  - `commission_amount`: Dollar amount (if fixed type)
  - `domain`: "vegvisr.org"
  - `expires_at`: 7 days from now (ISO string)
  - `status`: "pending"
  - `created_at`: Current timestamp

#### Step 4.2: Database Write Confirmation

- **Success**: Invitation record created with auto-increment ID
- **Error Handling**: Database errors caught and returned as 500 responses
- **Transaction**: Single INSERT operation (no complex transactions)

---

### **PHASE 5: Email Processing and User Verification**

#### Step 5.1: User Existence Check

- **Database**: D1 Database (`vegvisr_org`)
- **Table**: `config` table (main user table)
- **Query**: `SELECT user_id FROM config WHERE email = ?`
- **Logic Branching**:
  - If user exists â†’ Send affiliate invitation email with existing user flow
  - If user doesn't exist â†’ Send affiliate invitation email with registration verification link

#### Step 5.2: Email Template Processing

- **Template Source**: Retrieved from `email_templates` table
- **Template Type**: `affiliate_registration_invitation`
- **Template Engine**: Handlebars processing
- **Variables Substituted**:
  - `{{recipientName}}`: From invitation form
  - `{{senderName}}`: "Superadmin"
  - `{{siteName}}`: "Vegvisr.org"
  - `{{commissionRate}}`: From form (e.g., "15")
  - `{{commissionType}}`: "percentage" or "fixed"
  - `{{commissionAmount}}`: Dollar amount (if fixed type)
  - `{{affiliateRegistrationUrl}}`: **Different URLs based on user existence**

#### Step 5.3: Verification Link Generation and User Flow Branching

- **Single Template**: Always uses `affiliate_registration_invitation` template
- **Verification Link**: Contains invitation token for tracking
- **Link Destination**: Same verification endpoint for both user types
- **Backend Logic**: Determines user flow based on existence in `config` table

**Flow A - Existing User Verification:**

1. User clicks verification link with invitation token
2. System validates token from `affiliate_invitations` table
3. **Only updates `affiliates` table** with new record:
   ```sql
   INSERT INTO affiliates (
     affiliate_id, email, name, referral_code, domain,
     status, commission_rate, created_at, updated_at
   ) VALUES (?, ?, ?, ?, ?, 'active', ?, datetime('now'), datetime('now'))
   ```
4. **Deletes invitation** from `affiliate_invitations` table
5. User retains existing account, gains affiliate status

**Flow B - New User Verification:**

1. User clicks verification link with invitation token
2. System validates token from `affiliate_invitations` table
3. **Normal user registration flow** creates entry in `config` table
4. **Also updates `affiliates` table** with new affiliate record (same as Flow A)
5. **Deletes invitation** from `affiliate_invitations` table
6. User gets new account + affiliate status simultaneously

#### Step 5.4: Email Delivery (Single Template for Both Flows)

- **Service**: Real email delivery system (via slowyou.io or similar)
- **Method**: Real SMTP delivery (not simulation)
- **Email Content**: HTML formatted affiliate invitation from template
- **Subject**: "Join {{siteName}} as an Affiliate Partner! ðŸš€"
- **Template**: Same `affiliate_registration_invitation` template for all users
- **Verification Link**: Contains token that determines user flow on click
- **Delivery**: Email sent to recipient's inbox **regardless of existing user status**

---

### **PHASE 6: Post-Email User Actions (Two Verification Flows)**

#### Step 6.1: User Clicks Verification Link

- **Link Contains**: Invitation token from `affiliate_invitations` table
- **Backend Endpoint**: Verification handler receives token
- **Token Validation**: System validates token and retrieves invitation data
- **User Detection**: System checks if email exists in `config` table

#### Step 6.2A: Existing User Flow (Affiliate Addition Only)

- **User Status**: Already registered in `config` table
- **Action**: Add affiliate status to existing account
- **Database Operations**:
  1. **INSERT** new record into `affiliates` table with commission data
  2. **DELETE** invitation record from `affiliate_invitations` table
- **Result**: User retains existing account, gains affiliate privileges
- **Example Affiliate Record**:
  ```
  aff_1754139908191_tak5km6bd | john.doe@example.com | John Doe | JOHHX7PI1 |
  vegvisr.org | NULL | active | 15 | NULL | 2025-08-02 13:05:08 | 2025-08-02 13:05:08
  ```

#### Step 6.2B: New User Flow (Registration + Affiliate)

- **User Status**: Not registered in `config` table
- **Action**: Complete user registration AND affiliate setup
- **Database Operations**:
  1. **INSERT** new user record into `config` table (normal registration flow)
  2. **INSERT** new record into `affiliates` table with commission data
  3. **DELETE** invitation record from `affiliate_invitations` table
- **Result**: New user account created with immediate affiliate status

#### Step 6.3: Invitation Cleanup (Both Flows)

- **Database**: D1 Database
- **Table**: `affiliate_invitations`
- **Operation**: DELETE invitation record after successful verification
- **Purpose**: Prevent token reuse and maintain data hygiene
- **Token Status**: Invitation token becomes invalid after use

---

### **PHASE 7: Response and Confirmation**

#### Step 7.1: Success Response Generation

- **Worker**: main-worker generates success response
- **Response Format**: JSON with confirmation details
- **Response Example**:

```json
{
  "success": true,
  "message": "Affiliate invitation sent successfully! User will receive a verification email.",
  "invitationToken": "9a533b5b-a9f6-4df7-be6b-73c0f3ab2e53",
  "expiresAt": "2025-08-09T16:33:26.950Z",
  "registrationResponse": {
    "message": "Verification email sent successfully."
  },
  "nextStep": "User must check email and click verification link to activate account"
}
```

#### Step 7.2: Frontend Response Handling

- **Component**: `AffiliateManagement.vue`
- **Success Display**: Success message shown to Superadmin
- **Token Display**: Invitation token and expiry date displayed
- **UI Update**: Modal may close or show confirmation state

---

## ðŸŽ¯ FLOW SUMMARY

### **Complete Process Timeline:**

1. **Superadmin** opens affiliate management modal
2. **Frontend** collects invitation details and validates
3. **API Request** sends data to main-worker endpoint
4. **main-worker** retrieves affiliate email template from `email_templates` table
5. **Database** stores invitation token and metadata in `affiliate_invitations` table
6. **Email System** sends single affiliate template with verification link (regardless of user status)
7. **User Action** clicks verification link in email
8. **Backend Verification** determines user flow:
   - **Existing User**: Updates `affiliates` table only
   - **New User**: Creates `config` entry + updates `affiliates` table
9. **Invitation Cleanup** deletes record from `affiliate_invitations` table
10. **Frontend** displays confirmation to Superadmin (initial) and user (verification)

### **Key Corrections from Previous Analysis:**

- âœ… **Single Email Template**: Same `affiliate_registration_invitation` template for all users
- âœ… **Dual Verification Flows**: Different backend processing based on user existence
- âœ… **Existing User Flow**: Only updates `affiliates` table, no new registration
- âœ… **New User Flow**: Normal registration + affiliate table update
- âœ… **Invitation Cleanup**: Token deleted after successful verification in both flows
- âœ… **Role Flexibility**: Users can upgrade roles while maintaining affiliate status

### **Database Operations Summary:**

- **Always**: Store invitation in `affiliate_invitations` table
- **Always**: Send email with verification link
- **Existing User Verification**: `affiliates` INSERT + `affiliate_invitations` DELETE
- **New User Verification**: `config` INSERT + `affiliates` INSERT + `affiliate_invitations` DELETE

---

**Step 4 Status**: âœ… **COMPLETE FLOW ANALYSIS DOCUMENTED**
**Analysis Scope**: End-to-end process from Superadmin UI to email delivery
**Integration Points**: All major system components and their interactions identified
